<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.guang.resms.module.report.mapper.ReportMapper">

    <!-- 销售报表: 按销售人员统计 -->
    <select id="selectSaleReport" resultType="com.guang.resms.module.report.entity.vo.report.SaleReportVO">
        SELECT 
            u.real_name as staffName,
            t.team_name as teamName,
            COUNT(tr.id) as dealCount,
            IFNULL(SUM(tr.deal_price), 0) as totalDealAmount,
            IFNULL(SUM(com.amount), 0) as totalCommissionAmount
        FROM tb_user u
        LEFT JOIN tb_team_member tm ON u.id = tm.user_id
        LEFT JOIN tb_team t ON tm.team_id = t.id
        LEFT JOIN tb_transaction tr ON tr.sales_id = u.id 
            AND tr.status IN (3, 4)
            <if test="startDate != null and startDate != ''">
                AND tr.create_time &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND tr.create_time &lt;= #{endDate}
            </if>
        LEFT JOIN tb_commission com ON tr.id = com.transaction_id
        WHERE u.status = 1
          AND EXISTS (
            SELECT 1 FROM tb_user_role ur
            WHERE ur.user_id = u.id
              AND ur.role_id IN (2, 3)
          )
        GROUP BY u.id, u.real_name, t.team_name
        ORDER BY totalDealAmount DESC
    </select>

    <!-- 财务报表: 按月份统计 -->
    <select id="selectFinancialReport" resultType="com.guang.resms.module.report.entity.vo.report.FinancialReportVO">
        SELECT 
            DATE_FORMAT(payment_time, '%Y-%m') as period,
            SUM(CASE WHEN flow_type = 1 THEN amount ELSE 0 END) as totalIncome,
            SUM(CASE WHEN flow_type = 2 THEN amount ELSE 0 END) as totalRefund,
            SUM(CASE WHEN flow_type = 1 THEN amount ELSE -amount END) as netIncome,
            COUNT(id) as transactionCount
        FROM tb_payment
        WHERE payment_status = 1 -- 有效
        <if test="startDate != null and startDate != ''">
            AND payment_time &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND payment_time &lt;= #{endDate}
        </if>
        GROUP BY DATE_FORMAT(payment_time, '%Y-%m')
        ORDER BY period DESC
    </select>

    <!-- 客户报表: 按销售人员统计转化 -->
    <select id="selectCustomerReport" resultType="com.guang.resms.module.report.entity.vo.report.CustomerReportVO">
        SELECT 
            u.real_name as staffName,
            COUNT(DISTINCT c.id) as newCustomerCount,
            IFNULL(v.v_count, 0) as viewCount,
            IFNULL(tr.d_count, 0) as dealCount
        FROM tb_user u
        LEFT JOIN tb_customer c ON c.sales_id = u.id 
            <if test="startDate != null and startDate != ''">
                AND c.create_time &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND c.create_time &lt;= #{endDate}
            </if>
        LEFT JOIN (
            SELECT sales_id, COUNT(*) as v_count 
            FROM tb_view_record 
            WHERE 1=1
            <if test="startDate != null and startDate != ''">
                AND view_time &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND view_time &lt;= #{endDate}
            </if>
            GROUP BY sales_id
        ) v ON v.sales_id = u.id
        LEFT JOIN (
            SELECT sales_id, COUNT(*) as d_count 
            FROM tb_transaction 
            WHERE 1=1
              AND status IN (3, 4)
            <if test="startDate != null and startDate != ''">
                AND create_time &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND create_time &lt;= #{endDate}
            </if>
            GROUP BY sales_id
        ) tr ON tr.sales_id = u.id
        WHERE u.status = 1
          AND EXISTS (
            SELECT 1 FROM tb_user_role ur
            WHERE ur.user_id = u.id
              AND ur.role_id IN (2, 3)
          )
        GROUP BY u.id, u.real_name
        ORDER BY dealCount DESC
    </select>

</mapper>
