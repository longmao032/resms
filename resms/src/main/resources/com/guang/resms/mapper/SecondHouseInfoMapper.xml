<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.guang.resms.mapper.SecondHouseInfoMapper">
    
    <!-- 综合查询二手房信息 -->
    <select id="selectSecondHouseVoPage" resultType="com.guang.resms.entity.vo.SecondHouseVo">
        SELECT 
            h.layout, 
            h.area, 
            h.floor, 
            h.total_floor, 
            h.orientation, 
            FORMAT(h.price, 0) AS 'total_price_yuan', 
            CONCAT(FORMAT(h.price / 10000, 0), 'w') AS 'total_price_10k_yuan', 
            ROUND(h.price / h.area, 0) AS 'unit_price_yuan_per_sqm', 
            
            COALESCE(c.community_name, p.project_name) AS 'community_name', 
            COALESCE(c.address, p.address) AS 'detailed_address', 
            
            CASE 
                WHEN s.is_over_five = 1 THEN '满五'
                WHEN s.is_over_two = 1 THEN '满二'
                ELSE '其他'
            END AS 'tax_status', 
            
            CASE s.is_only_house 
                WHEN 1 THEN '唯一住房'
                ELSE '非唯一住房'
            END AS 'house_property_type', 
            
            h.description AS 'house_description', 
            s.description AS 'detailed_house_description', 
            
            s.build_year, 
            h.decoration, 
            h.house_no, 
            h.create_time AS 'publish_time', 
            h.update_time AS 'update_time' 
            
        FROM tb_house h 
        LEFT JOIN tb_second_house_info s ON h.id = s.house_id 
        LEFT JOIN tb_second_house_community c ON s.community_id = c.id 
        LEFT JOIN tb_project p ON h.project_id = p.id 
        WHERE h.house_type = 1 
          AND h.status = 1 
          AND (COALESCE(c.city, p.city) = #{params.city})
        
        <if test="params.layout != null and params.layout != ''">
            AND h.layout LIKE CONCAT('%', #{params.layout}, '%')
        </if>
        
        <if test="params.minArea != null">
            AND h.area >= #{params.minArea}
        </if>
        
        <if test="params.maxArea != null">
            AND h.area &lt;= #{params.maxArea}
        </if>
        
        <if test="params.minPrice != null">
            AND h.price >= #{params.minPrice}
        </if>
        
        <if test="params.maxPrice != null">
            AND h.price &lt;= #{params.maxPrice}
        </if>
        
        <if test="params.district != null and params.district != ''">
            AND c.district = #{params.district}
        </if>
        
        <if test="params.searchKeyword != null and params.searchKeyword != ''">
            AND (
                c.community_name LIKE CONCAT('%', #{params.searchKeyword}, '%')
                OR c.address LIKE CONCAT('%', #{params.searchKeyword}, '%')
            )
        </if>
        
        ORDER BY 
            <choose>
                <when test="params.sortField == 'area' and params.sortOrder == 'asc'">
                    h.area ASC
                </when>
                <when test="params.sortField == 'area' and params.sortOrder == 'desc'">
                    h.area DESC
                </when>
                <when test="params.sortField == 'price' and params.sortOrder == 'asc'">
                    h.price ASC
                </when>
                <when test="params.sortField == 'price' and params.sortOrder == 'desc'">
                    h.price DESC
                </when>
                <when test="params.sortField == 'unit_price' and params.sortOrder == 'asc'">
                    h.price / h.area ASC
                </when>
                <when test="params.sortField == 'unit_price' and params.sortOrder == 'desc'">
                    h.price / h.area DESC
                </when>
                <otherwise>
                    h.price / h.area ASC, 
                    h.create_time DESC
                </otherwise>
            </choose>
    </select>
</mapper>