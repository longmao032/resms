<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.guang.resms.mapper.MenuMapper">

    <!-- MenuTreeVO结果映射 -->
    <resultMap id="MenuTreeVOResult" type="com.guang.resms.entity.vo.MenuTreeVO">
        <id property="id" column="id"/>
        <result property="menuName" column="permission_name"/>
        <result property="menuCode" column="permission_code"/>
        <result property="parentId" column="parent_id"/>
        <result property="menuType" column="permission_type"/>
        <result property="path" column="path"/>
        <result property="component" column="component"/>
        <result property="icon" column="icon"/>
        <result property="sortOrder" column="sort_order"/>
        <result property="description" column="description"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <!-- 查询所有菜单列表 -->
    <select id="selectMenuList" resultMap="MenuTreeVOResult">
        SELECT
            p.id,
            p.permission_name,
            p.permission_code,
            p.parent_id,
            p.permission_type,
            p.path,
            p.component,
            p.icon,
            p.sort_order,
            p.description,
            p.status,
            p.create_time,
            p.update_time,
            CASE p.permission_type
                WHEN 1 THEN '菜单'
                WHEN 2 THEN '按钮'
                WHEN 3 THEN '数据'
                ELSE '未知'
            END AS menu_type_text,
            CASE p.status
                WHEN 0 THEN '禁用'
                WHEN 1 THEN '启用'
                ELSE '未知'
            END AS status_text,
            (SELECT permission_name FROM tb_permission WHERE id = p.parent_id) AS parent_name
        FROM
            tb_permission p
        <where>
            <if test="params.menuName != null and params.menuName != ''">
                AND p.permission_name LIKE CONCAT('%', #{params.menuName}, '%')
            </if>
            <if test="params.menuCode != null and params.menuCode != ''">
                AND p.permission_code LIKE CONCAT('%', #{params.menuCode}, '%')
            </if>
            <if test="params.menuType != null">
                AND p.permission_type = #{params.menuType}
            </if>
            <if test="params.status != null">
                AND p.status = #{params.status}
            </if>
            <if test="params.parentId != null">
                AND p.parent_id = #{params.parentId}
            </if>
        </where>
        ORDER BY p.parent_id, p.sort_order ASC, p.id ASC
    </select>

    <!-- 根据ID查询菜单详情 -->
    <select id="selectMenuById" resultMap="MenuTreeVOResult">
        SELECT
            p.id,
            p.permission_name,
            p.permission_code,
            p.parent_id,
            p.permission_type,
            p.path,
            p.component,
            p.icon,
            p.sort_order,
            p.description,
            p.status,
            p.create_time,
            p.update_time,
            CASE p.permission_type
                WHEN 1 THEN '菜单'
                WHEN 2 THEN '按钮'
                WHEN 3 THEN '数据'
                ELSE '未知'
            END AS menu_type_text,
            CASE p.status
                WHEN 0 THEN '禁用'
                WHEN 1 THEN '启用'
                ELSE '未知'
            END AS status_text,
            (SELECT permission_name FROM tb_permission WHERE id = p.parent_id) AS parent_name
        FROM
            tb_permission p
        WHERE
            p.id = #{id}
    </select>

    <!-- 查询子菜单数量 -->
    <select id="countChildrenByParentId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM tb_permission
        WHERE parent_id = #{parentId}
    </select>

    <!-- 检查菜单编码唯一性 -->
    <select id="checkMenuCodeUnique" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM tb_permission
        WHERE permission_code = #{menuCode}
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- 检查菜单名称唯一性（同父级下） -->
    <select id="checkMenuNameUnique" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM tb_permission
        WHERE permission_name = #{menuName}
        AND parent_id = #{parentId}
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- 批量更新菜单排序 -->
    <update id="batchUpdateSort">
        <foreach collection="sortList" item="item" separator=";">
            UPDATE tb_permission
            SET sort_order = #{item.sortOrder}, update_time = NOW()
            WHERE id = #{item.id}
        </foreach>
    </update>

    <!-- 更新菜单状态 -->
    <update id="updateMenuStatus">
        UPDATE tb_permission
        SET status = #{status}, update_time = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 递归查询所有子菜单ID -->
    <select id="selectChildrenIds" resultType="java.lang.Integer">
        WITH RECURSIVE menu_tree AS (
            -- 锚点成员：选择直接子菜单
            SELECT id
            FROM tb_permission
            WHERE parent_id = #{parentId}
            
            UNION ALL
            
            -- 递归成员：选择子菜单的子菜单
            SELECT p.id
            FROM tb_permission p
            INNER JOIN menu_tree mt ON p.parent_id = mt.id
        )
        SELECT id FROM menu_tree
    </select>

    <!-- 查询角色关联的菜单数量 -->
    <select id="countRoleMenuByMenuId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM tb_role_permission
        WHERE permission_id = #{menuId}
    </select>

</mapper>
