<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.guang.resms.mapper.TransactionMapper">
    <select id="selectPageVO" resultType="com.guang.resms.entity.vo.TransactionVO">
        SELECT t.id, t.transaction_no, t.deal_price, t.loan_status, t.status, t.manager_audit, t.create_time,
               h.house_no, h.unit_name,
               c.real_name AS customer_name, c.phone AS customer_phone,
               u.real_name AS sales_name
        FROM tb_transaction t
        LEFT JOIN tb_house h ON t.house_id = h.id
        LEFT JOIN tb_customer c ON t.customer_id = c.id
        LEFT JOIN tb_user u ON t.sales_id = u.id
        WHERE 1=1
        <if test="dto.transactionNo != null and dto.transactionNo != ''">
          AND t.transaction_no LIKE CONCAT('%', #{dto.transactionNo}, '%')
        </if>
        <if test="dto.customerName != null and dto.customerName != ''">
          AND c.real_name LIKE CONCAT('%', #{dto.customerName}, '%')
        </if>
        <if test="dto.status != null">
          AND t.status = #{dto.status}
        </if>
        ORDER BY t.create_time DESC
    </select>

    <select id="selectDetailVO" resultType="com.guang.resms.entity.vo.TransactionVO">
        SELECT t.id, t.transaction_no, t.deal_price, t.deposit, t.down_payment, t.loan_amount,
               t.loan_status, t.status, t.manager_audit, t.create_time,
               (t.deal_price - COALESCE(t.deposit, 0) - COALESCE(t.down_payment, 0) - COALESCE(t.loan_amount, 0)) AS final_payment,
               h.house_no, h.unit_name,
               c.real_name AS customer_name, c.phone AS customer_phone,
               u.real_name AS sales_name
        FROM tb_transaction t
        LEFT JOIN tb_house h ON t.house_id = h.id
        LEFT JOIN tb_customer c ON t.customer_id = c.id
        LEFT JOIN tb_user u ON t.sales_id = u.id
        WHERE t.id = #{id}
    </select>
</mapper>
