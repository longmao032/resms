<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.guang.resms.mapper.HouseMapper">

    <!-- 结果映射 -->
    <resultMap id="HouseVOResultMap" type="com.guang.resms.entity.vo.HouseVO">
        <id property="id" column="id"/>
        <result property="houseNo" column="house_no"/>
        <result property="area" column="area"/>
        <result property="unitName" column="unit_name"/>
        <result property="layout" column="layout"/>
        <result property="floor" column="floor"/>
        <result property="totalFloor" column="total_floor"/>
        <result property="orientation" column="orientation"/>
        <result property="decoration" column="decoration"/>
        <result property="price" column="price"/>
        <result property="status" column="status"/>
        <result property="salesId" column="sales_id"/>
        <result property="salesName" column="sales_name"/>
        <result property="description" column="description"/>
        <result property="houseType" column="house_type"/>
        <result property="buildingNo" column="building_no"/>
        <result property="projectId" column="project_id"/>
        <result property="projectName" column="project_name"/>
        <result property="province" column="province"/>
        <result property="city" column="city"/>
        <result property="district" column="district"/>
        <result property="address" column="address"/>
        <result property="fullAddress" column="full_address"/>
        <result property="roomNo" column="room_no"/>
        <result property="coverImage" column="cover_image"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <!-- 基础查询列 -->
    <sql id="Base_Column_List">
        h.id, h.house_no, h.area, h.unit_name, h.layout, h.floor, h.total_floor,
        h.orientation, h.decoration, h.price, h.status, h.sales_id, h.description,
        h.house_type, h.building_no, h.project_id, h.room_no, h.create_time, h.update_time
    </sql>

    <!-- 项目地址列 -->
    <sql id="Project_Address_Columns">
        p.province, p.city, p.district, p.address,
        CONCAT(
            COALESCE(p.province, ''), 
            COALESCE(p.city, ''), 
            COALESCE(p.district, ''), ' ',
            COALESCE(p.address, ''), ' ',
            COALESCE(h.building_no, ''), '栋 ',
            COALESCE(h.room_no, ''), '室'
        ) AS full_address
    </sql>

    <!-- 查询条件 -->
    <sql id="Query_Condition">
        <where>
            <if test="query.houseNo != null and query.houseNo != ''">
                AND h.house_no LIKE CONCAT('%', #{query.houseNo}, '%')
            </if>
            <if test="query.layout != null and query.layout != ''">
                AND h.layout LIKE CONCAT('%', #{query.layout}, '%')
            </if>
            <if test="query.houseType != null">
                AND h.house_type = #{query.houseType}
            </if>
            <if test="query.status != null">
                AND h.status = #{query.status}
            </if>
            <if test="query.salesId != null">
                AND h.sales_id = #{query.salesId}
            </if>
            <if test="query.projectId != null">
                AND h.project_id = #{query.projectId}
            </if>
            <if test="query.minArea != null">
                AND h.area &gt;= #{query.minArea}
            </if>
            <if test="query.maxArea != null">
                AND h.area &lt;= #{query.maxArea}
            </if>
            <if test="query.minPrice != null">
                AND h.price &gt;= #{query.minPrice}
            </if>
            <if test="query.maxPrice != null">
                AND h.price &lt;= #{query.maxPrice}
            </if>
            <if test="query.minFloor != null">
                AND h.floor &gt;= #{query.minFloor}
            </if>
            <if test="query.maxFloor != null">
                AND h.floor &lt;= #{query.maxFloor}
            </if>
            <if test="query.orientation != null and query.orientation != ''">
                AND h.orientation = #{query.orientation}
            </if>
            <if test="query.decoration != null and query.decoration != ''">
                AND h.decoration = #{query.decoration}
            </if>
            <!-- 数据权限控制 -->
            <if test="query.dataScope == 4">
                <!-- 仅本人数据 -->
                AND h.sales_id = #{query.currentUserId}
            </if>
        </where>
    </sql>

    <!-- 分页查询房源列表（带关联信息） -->
    <select id="selectHouseListWithDetails" resultMap="HouseVOResultMap">
        SELECT
            <include refid="Base_Column_List"/>,
            u.real_name AS sales_name,
            p.project_name AS project_name,
            <include refid="Project_Address_Columns"/>,
            (SELECT img.image_url FROM tb_house_image img 
             WHERE img.house_id = h.id AND img.image_type = 1 
             ORDER BY img.sort_order ASC LIMIT 1) AS cover_image
        FROM tb_house h
        LEFT JOIN tb_user u ON h.sales_id = u.id
        LEFT JOIN tb_project p ON h.project_id = p.id
        <include refid="Query_Condition"/>
        ORDER BY
            <choose>
                <when test="query.orderBy != null and query.orderBy != ''">
                    h.${query.orderBy}
                    <if test="query.order != null and query.order != ''">
                        ${query.order}
                    </if>
                </when>
                <otherwise>
                    h.create_time DESC
                </otherwise>
            </choose>
        <if test="query.pageNum != null and query.pageSize != null">
            LIMIT #{query.pageSize} OFFSET #{query.pageNum}
        </if>
    </select>

    <!-- 查询房源总数 -->
    <select id="selectHouseCount" resultType="java.lang.Long">
        SELECT COUNT(*) FROM tb_house h
        <include refid="Query_Condition"/>
    </select>

    <!-- 根据ID查询房源详情（包含关联信息） -->
    <select id="selectHouseDetailById" resultMap="HouseVOResultMap">
        SELECT
            <include refid="Base_Column_List"/>,
            u.real_name AS sales_name,
            p.project_name AS project_name,
            <include refid="Project_Address_Columns"/>,
            (SELECT img.image_url FROM tb_house_image img 
             WHERE img.house_id = h.id AND img.image_type = 1 
             ORDER BY img.sort_order ASC LIMIT 1) AS cover_image
        FROM tb_house h
        LEFT JOIN tb_user u ON h.sales_id = u.id
        LEFT JOIN tb_project p ON h.project_id = p.id
        WHERE h.id = #{id}
    </select>

    <!-- 生成房源编号 -->
    <select id="generateHouseNo" resultType="java.lang.String">
        SELECT CONCAT(
            'FC',
            DATE_FORMAT(NOW(), '%Y%m%d'),
            LPAD(
                IFNULL(
                    (SELECT SUBSTRING(house_no, -4) + 1
                     FROM tb_house
                     WHERE house_no LIKE CONCAT('FC', DATE_FORMAT(NOW(), '%Y%m%d'), '%')
                     ORDER BY house_no DESC
                     LIMIT 1),
                    1
                ),
                4,
                '0'
            )
        ) AS house_no
    </select>

    <!-- 检查房源编号是否唯一 -->
    <select id="isHouseNoUnique" resultType="java.lang.Boolean">
        SELECT COUNT(*) = 0
        FROM tb_house
        WHERE house_no = #{houseNo}
        <if test="id != null">
            AND id != #{id}
        </if>
    </select>

    <!-- 批量更新房源状态 -->
    <update id="batchUpdateStatus">
        UPDATE tb_house
        SET status = #{status},
            update_time = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </update>

    <!-- 批量分配房源给销售 -->
    <update id="batchAssignSales">
        UPDATE tb_house
        SET sales_id = #{salesId},
            update_time = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </update>

    <!-- 查询房源图片列表 -->
    <select id="selectHouseImages" resultType="java.lang.String">
        SELECT image_url
        FROM tb_house_image
        WHERE house_id = #{houseId}
        ORDER BY sort_order ASC
    </select>

    <!-- 查询新房扩展信息 -->
    <select id="selectNewHouseInfo" resultType="com.guang.resms.entity.vo.NewHouseInfoVO">
        SELECT
            nhi.id,
            nhi.house_id,
            nhi.pre_sale_license_no AS estate_name,
            NULL AS building,
            NULL AS unit,
            NULL AS room,
            p.opening_time AS opening_date,
            nhi.estimated_delivery_time AS delivery_date,
            p.status AS sale_status,
            NULL AS remark
        FROM tb_new_house_info nhi
        LEFT JOIN tb_house h ON nhi.house_id = h.id
        LEFT JOIN tb_project p ON h.project_id = p.id
        WHERE nhi.house_id = #{houseId}
    </select>

    <!-- 查询二手房扩展信息 -->
    <select id="selectSecondHouseInfo" resultType="com.guang.resms.entity.vo.SecondHouseInfoVO">
        SELECT
            shi.id,
            shi.house_id,
            shi.community_id,
            p.project_name AS community_name,
            YEAR(CURDATE()) - shi.build_year AS house_age,
            70 AS property_right,
            shi.last_transaction_time AS last_trade_date,
            shi.mortgage_status,
            CASE WHEN shi.is_only_house = 1 THEN 1 ELSE 0 END AS certificate_status,
            shi.description AS remark
        FROM tb_second_house_info shi
        LEFT JOIN tb_house h ON shi.house_id = h.id
        LEFT JOIN tb_project p ON h.project_id = p.id
        WHERE shi.house_id = #{houseId}
    </select>

    <!-- 查询项目详细信息 -->
    <select id="selectProjectInfo" resultType="com.guang.resms.entity.vo.ProjectVO">
        SELECT
            id,
            project_no,
            project_name,
            developer,
            property_company,
            address,
            total_area AS land_area,
            plot_ratio,
            greening_rate,
            parking_ratio,
            total_households AS total_houses,
            property_fee,
            property_type AS building_type,
            opening_time AS opening_date,
            completion_time AS delivery_date,
            description,
            province,
            city,
            district,
            longitude,
            latitude,
            metro_distance,
            metro_station AS nearest_metro,
            school_district,
            business_district AS business_circle,
            cover_url AS cover_image,
            status,
            create_time,
            update_time
        FROM tb_project
        WHERE id = #{projectId}
    </select>

</mapper>
