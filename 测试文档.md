# 房产销售管理系统（RESMS）测试文档

- **文档版本**：V1.0
- **编写日期**：2025-12-18
- **项目组成**：
  - **后端**：Spring Boot 3.5.x + MyBatis-Plus 3.5.x + MySQL 8.x
  - **前端**：Vue 3 + Vite + Element Plus + Pinia

---

## 1. 测试目标

- 验证系统核心业务流程可用：**房源管理 → 客户/带看 → 交易流转 → 收款 → 佣金核算/发放 → 报表/统计**。
- 验证系统管理功能可用：**用户/角色/权限/菜单/操作日志**。
- 验证多角色权限隔离正确：系统管理员、销售顾问、销售经理、财务人员、普通用户。
- 验证系统稳定性与基础安全：登录态、鉴权、文件上传校验、导出下载、并发场景（交易创建锁）。

---

## 2. 测试范围

### 2.1 前端功能模块（路由）

- **登录/会话**：`/login`
- **系统管理**：
  - 用户管理：`/system/user`
  - 角色管理：`/system/role`
  - 权限管理：`/system/permission`
  - 菜单管理：`/system/menu`
  - 操作日志：`/system/log`
  - 系统设置：`/settings`
- **房源管理**：
  - 房源列表：`/house/list`
  - 新增房源：`/house/add`
  - 编辑房源：`/house/edit/:id`
  - 房源详情：`/house/detail/:id`
  - 房源审核：`/house/audit`
  - 房源统计：`/house/statistics`
- **项目/小区管理**：
  - 楼盘列表：`/project/list`、新增：`/project/add`、详情/编辑：`/project/detail/:id`、`/project/edit/:id`
  - 小区列表：`/community/list`、新增：`/community/add`、详情/编辑：`/community/detail/:id`、`/community/edit/:id`
- **客户管理**：
  - 客户列表：`/customer/list`
  - 客户跟进/带看：`/customer/follow`
  - 客户统计：`/customer/statistics`
- **交易管理**：
  - 交易列表：`/transaction/list`
  - 交易审核：`/transaction/audit`
  - 交易统计：`/transaction/statistics`
- **收款管理**：
  - 收款记录：`/payment/list`
  - 收款统计：`/payment/statistics`
- **佣金管理**：
  - 佣金列表：`/commission/list`
  - 佣金核算：`/commission/calculate`
  - 佣金统计：`/commission/statistics`
- **团队管理**：
  - 团队列表：`/team/list`
  - 团队业绩：`/team/performance`
- **工作通知**：`/work-notice/list`
- **报表**：`/report/sale`、`/report/financial`、`/report/customer`
- **个人中心**：`/profile`（含资料/密码）
- **在线聊天**：`/chat`

### 2.2 后端接口范围（Controller 入口）

- **认证**：`/auth/login`、`/auth/csrf-token`
- **用户/角色/权限/菜单**：`/user/*`、`/role/*`、`/permission/*`、`/menu/*`
- **房源**：`/house/*`
- **项目**：`/projects/*`
- **小区**：`/community/*`
- **二手房筛选**：`/second-house/filtered`
- **客户**：`/customer/*`
- **带看/预约**：`/view-record/*`
- **交易**：`/transaction/*`
- **收款**：`/payment/*`
- **佣金**：`/commission/*`
- **团队**：`/team/*`
- **通知**：`/work-notice/*`
- **聊天**：`/chat/*`
- **统计**：`/statistics/*`
- **报表导出**：`/report/*`
- **文件上传**：`/common/upload`、`/payment/uploadProof`、`/community/uploadCover`、`/chat/upload/image`、`/house/upload`
- **操作日志**：`/operation-log/page`

### 2.3 不在范围（本轮）

- UI/交互细节的视觉验收（色彩、动效、像素级对齐）
- 压力测试到极限容量（可留作后续性能专项）
- 安全渗透测试（SQLi/XSS/CSRF 全面专项）

---

## 3. 角色与权限模型（测试关注点）

系统基于 `tb_role` / `tb_user_role`，角色 ID 同 `roleType`：

| 角色ID(roleType) | 角色名称 | 典型职责 |
|---|---|---|
| 1 | 系统管理员 | 拥有所有权限；系统配置、审核、发放、导出等 |
| 2 | 销售顾问 | 客户/房源/交易的业务执行；交易查看范围通常为本人 |
| 3 | 销售经理 | 管理团队、审核交易、管理房源/项目/小区等（部分写权限） |
| 4 | 财务人员 | 收款、贷款相关字段、佣金核算/发放（与管理员共享部分权限） |
| 5 | 普通用户 | 只读或受限访问（根据菜单/权限下发） |

鉴权要点：
- 后端 `JwtAuthInterceptor` 对除 `/auth/login` 外请求校验 `Authorization: Bearer <token>`。
- token 内含 `userId`、`roleType`、`realName`、`teamId`，有效期 24h。
- **角色变更后 token 立刻失效**（tokenRoleId 与 DB 当前主角色不一致将返回 401）。

---

## 4. 测试环境

### 4.1 软件环境

- **后端**：
  - JDK：17
  - Spring Boot：3.5.7
  - MyBatis-Plus：3.5.14
  - MySQL：8.x（建议 8.0+，项目 SQL 标注 8.4.7）
- **前端**：
  - Node.js：建议 18/20
  - Vue：3.5.x
  - Vite：5.4.x
  - Element Plus：2.11.x

### 4.2 服务配置（默认）

- 后端端口：`8080`
- DB：`jdbc:mysql://localhost:3306/hms_sys`
- 上传目录：`uploads`（`file.upload.path`）
- feature 开关：
  - `feature.chat.enabled=true`
  - `feature.notice.enabled=true`

### 4.3 浏览器/兼容性

- **推荐**：Chrome 最新版、Edge 最新版
- **兼容性抽测**：Firefox 最新版

---

## 5. 测试数据准备

### 5.1 初始化数据

- 执行 `hms_sys.sql` 初始化数据库 `hms_sys`。

### 5.2 推荐测试账号（来自初始化 SQL，可按需调整）

| 角色 | 用户名 | 密码 | 备注 |
|---|---|---|---|
| 系统管理员 | `zhangsan` | `123456` | 用户 id=1 |
| 销售经理 | `mg1` / `manager2` | `123456` | 示例经理账号 |
| 销售顾问 | `ss1` / `ss3` / `ss4` 等 | `123456` | 示例销售账号 |
| 财务人员 | `ff1` / `finance2` | `123456` | 示例财务账号 |
| 普通用户 | `uu1` / `user2` | `123456` | 示例普通账号 |

### 5.3 关键业务数据（示例）

- 房源：`tb_house` 已有多条示例数据（如 `FC20240001` 等）。
- 交易：交易创建依赖房源状态为“在售”。

---

## 6. 测试策略

- **优先级原则**：先核心链路后边缘功能。
- **测试层级**：
  - 功能测试：页面操作 + 接口响应
  - 权限测试：不同角色访问同一功能/接口
  - 异常测试：非法参数、未登录、token 失效、功能开关禁用
  - 并发测试：同一房源重复创建交易、并发锁验证
  - 文件测试：上传类型、大小、路径回显、预览/下载
  - 导出测试：报表导出文件名/内容/权限

---

## 7. 关键状态枚举（用于断言）

### 7.1 房源状态（后端注释）

- `0=待审核`
- `1=在售`
- `2=已预订`
- `3=已成交`
- `4=下架`

### 7.2 交易状态（前端 `TransactionStatusMap`）

- `0=待付定金`
- `1=已付定金`
- `2=已付首付`
- `3=已过户`
- `4=已完成`
- `5=已取消`

### 7.3 经理审核（前端 `AuditStatusMap`）

- `0=待审核`
- `1=已通过`
- `2=已驳回`

### 7.4 贷款状态（前端 `LoanStatusMap`）

- `0=未申请`
- `1=审核中`
- `2=已放款`
- `3=未通过`

### 7.5 完成审核（前端 `FinishAuditMap`）

- `0=未申请`
- `1=待审核`
- `2=已通过`
- `3=已驳回`

### 7.6 佣金状态（前端 `CommissionStatusMap`）

- `0=待核算`
- `1=已核算`
- `2=已发放`

---

## 8. 测试用例

说明：下述用例以“可执行”为目标，字段包括：**用例ID、模块、场景、前置条件、步骤、期望结果、优先级**。

### 8.1 认证与会话

| 用例ID | 场景 | 前置条件 | 步骤 | 期望结果 | 优先级 |
|---|---|---|---|---|---|
| TC-AUTH-001 | 正确账号密码登录 | 存在管理员账号 | 1. 打开 `/login` 2. 输入 `zhangsan/123456` 3. 登录 | 登录成功，进入后台首页，token 存入本地 | P0 |
| TC-AUTH-002 | 密码错误登录 | 账号存在 | 输入错误密码登录 | 返回业务失败，页面提示“用户名或密码错误”等信息 | P0 |
| TC-AUTH-003 | 未登录访问受保护路由 | 清除 token | 直接访问 `/house/list` | 自动跳转 `/login` | P0 |
| TC-AUTH-004 | token 过期/无效 | 伪造/删除 token | 带无效 token 请求任意接口 | 返回 401，前端清理登录态并跳转登录 | P0 |
| TC-AUTH-005 | 角色变更后 token 失效 | A 登录后后台改其角色 | 1. A 登录拿 token 2. 管理员修改 A 角色 3. A 再请求接口 | 返回 401“角色已变更，请重新登录” | P1 |

### 8.2 用户管理（系统管理员）

| 用例ID | 场景 | 前置条件 | 步骤 | 期望结果 | 优先级 |
|---|---|---|---|---|---|
| TC-USER-001 | 查询用户分页 | 管理员登录 | 打开用户管理，设置条件查询 | 列表返回正确，总数/分页正确 | P1 |
| TC-USER-002 | 新增用户（指定角色） | 管理员登录 | 新增用户，填写必填项，选择角色 | 新增成功；列表可查到；默认状态正确 | P0 |
| TC-USER-003 | 编辑用户信息 | 管理员登录 | 编辑手机号/邮箱/角色/状态 | 保存成功；刷新后数据一致 | P0 |
| TC-USER-004 | 禁用用户后无法登录 | 管理员禁用某账号 | 使用该账号登录 | 登录失败/提示账号不可用（或提示鉴权失败） | P1 |
| TC-USER-005 | 删除用户 | 管理员登录 | 删除非内置用户 | 删除成功；相关关联（角色）不异常 | P1 |

### 8.3 角色/权限/菜单

| 用例ID | 场景 | 前置条件 | 步骤 | 期望结果 | 优先级 |
|---|---|---|---|---|---|
| TC-RP-001 | 角色分页查询 | 管理员登录 | 打开角色管理查询 | 返回正确分页 | P2 |
| TC-RP-002 | 配置角色权限后立即生效 | 管理员登录 | 1. 给某角色移除某权限 2. 该角色用户刷新/重新登录 | 无权限访问对应路由/接口；若 token 未重登则可能触发 401 重新登录 | P1 |
| TC-RP-003 | 权限树加载 | 管理员登录 | 打开权限管理/树 | 树形结构正确、可展开 | P2 |
| TC-RP-004 | 菜单状态禁用 | 管理员登录 | 禁用菜单/权限后重新登录 | 菜单不显示/无法进入 | P2 |

### 8.4 房源管理

| 用例ID | 场景 | 前置条件 | 步骤 | 期望结果 | 优先级 |
|---|---|---|---|---|---|
| TC-HOUSE-001 | 房源列表查询 | 登录任意有权限角色 | 进入房源列表，按编号/户型/类型/状态查询 | 查询结果与条件匹配 | P0 |
| TC-HOUSE-002 | 新增房源（非财务） | 管理员/经理/销售顾问 | 进入新增房源，填写必填项并保存 | 新增成功；可在列表查到；图片可上传 | P0 |
| TC-HOUSE-003 | 财务无权限新增/编辑 | 财务登录 | 点击新增/编辑 | 前端提示无权限；接口也应拒绝（如有） | P1 |
| TC-HOUSE-004 | 房源审核通过/驳回 | 管理员/审核角色 | 对待审核房源执行审核 | 状态正确变化；列表展示状态文本正确 | P1 |
| TC-HOUSE-005 | 上传房源图片校验 | 非财务登录 | 上传非图片/超5MB/超过10张 | 返回失败提示；合法图片返回可访问路径 | P1 |

### 8.5 项目/小区/二手房筛选

| 用例ID | 场景 | 前置条件 | 步骤 | 期望结果 | 优先级 |
|---|---|---|---|---|---|
| TC-PROJ-001 | 项目分页列表 | 登录 | 打开楼盘列表查询 | 返回分页正确 | P2 |
| TC-PROJ-002 | 新增/编辑项目（含封面） | 管理员/销售经理 | 新增/编辑，上传封面 | 保存成功；详情页显示封面 | P1 |
| TC-PROJ-003 | 删除/审核项目（管理员） | 管理员登录 | 删除/审核 | 成功；非管理员应返回 403 | P1 |
| TC-COMM-001 | 小区新增/编辑/审核 | 管理员/销售经理 | 新增/编辑；管理员审核 | 状态变化正确；封面上传校验生效 | P2 |
| TC-SECOND-001 | 二手房筛选接口 | 登录 | 请求 `/second-house/filtered` 组合筛选条件 | 返回分页结构正确，排序生效 | P3 |

### 8.6 客户与带看/预约

| 用例ID | 场景 | 前置条件 | 步骤 | 期望结果 | 优先级 |
|---|---|---|---|---|---|
| TC-CUST-001 | 客户分页查询 | 登录 | 客户列表筛选查询 | 返回分页正确 | P1 |
| TC-CUST-002 | 新增/更新客户 | 销售顾问/管理员 | 新增客户并保存 | 保存成功，客户可被交易选择 | P0 |
| TC-VIEW-001 | 创建预约带看 | 销售顾问 | 调用/页面创建预约 | 创建成功；带看记录状态为“预约中/待确认”（按实现） | P1 |
| TC-VIEW-002 | 确认预约 | 销售/经理 | 确认预约接口 | 状态更新成功 | P2 |
| TC-VIEW-003 | 完成带看并填写反馈 | 销售/经理 | 完成接口提交 feedback | 状态为完成，反馈保存 | P2 |
| TC-VIEW-004 | 取消预约 | 销售/经理 | 取消并给原因 | 状态为取消，原因记录 | P2 |

### 8.7 交易管理（核心链路）

| 用例ID | 场景 | 前置条件 | 步骤 | 期望结果 | 优先级 |
|---|---|---|---|---|---|
| TC-TX-001 | 新建交易成功 | 房源状态=在售；客户存在；销售存在 | 交易列表点击新建，选择房源/客户/销售/成交价 | 新建成功；交易状态=待付定金；经理审核=待审核 | P0 |
| TC-TX-002 | 同房源重复创建交易（并发/重复） | 同一房源已有未取消交易 | 再次新建交易 | 返回失败“该房源已有进行中的交易，禁止重复创建” | P0 |
| TC-TX-003 | 销售顾问只能看到自己的交易 | roleType=2 | 查询交易列表 | 只返回 salesId=本人记录 | P1 |
| TC-TX-004 | 经理审核通过/驳回 | roleType=3 或管理员 | 对待审核交易执行 managerApprove(true/false) | 审核字段变化正确；驳回原因可记录/提示 | P1 |
| TC-TX-005 | 待付定金阶段录入定金必须先经理通过 | roleType=4 或管理员录入定金 | 经理审核未通过时录入定金 | 返回失败“待付定金阶段必须经理审核通过后才允许录入定金” | P0 |
| TC-TX-006 | 财务录入定金自动流转状态 | 经理审核通过；原状态=待付定金 | 财务录入 deposit>0 | 状态自动变为“已付定金”，并自动记录 depositTime | P0 |
| TC-TX-007 | 财务录入首付自动流转 | 原状态=已付定金 | 录入 downPayment>0 | 状态变为“已付首付”，记录 downPaymentTime | P0 |
| TC-TX-008 | 财务申请完成审核 | roleType=4；已付清款项（按页面规则） | 点击“申请完成” | finishAudit 进入待审核；管理员可审批 | P1 |
| TC-TX-009 | 完成审核通过后禁止普通编辑篡改 | status=已完成 且 finishAudit=已通过 | 调用普通更新接口修改字段 | 返回失败“交易已完成且已通过完成审核，禁止修改” | P1 |

并发专项（建议）：
- 通过两端同时对同一房源发起 `/transaction` 创建请求，验证：
  - `selectByIdForUpdate` 行锁生效（第二个请求等待/最终失败）
  - 最终只有一笔有效交易存在

### 8.8 收款管理

| 用例ID | 场景 | 前置条件 | 步骤 | 期望结果 | 优先级 |
|---|---|---|---|---|---|
| TC-PAY-001 | 新增收款记录 | 财务/管理员 | 新增收款，绑定交易ID，填写金额等 | 新增成功；列表可查到 | P0 |
| TC-PAY-002 | 确认收款 | 财务/管理员 | 调用 `/payment/{id}/confirm` | 状态变为已确认；统计变化 | P1 |
| TC-PAY-003 | 作废收款需原因 | 财务/管理员 | 调用 `/payment/{id}/void?reason=...` | 作废成功，原因保留 | P1 |
| TC-PAY-004 | 上传收款凭证校验 | 财务/管理员 | 上传非图片/超5MB | 返回失败提示；合法图片返回相对路径 | P1 |

### 8.9 佣金管理

| 用例ID | 场景 | 前置条件 | 步骤 | 期望结果 | 优先级 |
|---|---|---|---|---|---|
| TC-COMM-001 | 佣金列表查询 | 管理员/财务 | 查询佣金列表 | 返回分页正确 | P2 |
| TC-COMM-002 | 佣金核算（权限） | 财务/管理员 | 调用 `/commission/calculate/{id}` | 成功；非财务/非管理员应 403 | P1 |
| TC-COMM-003 | 佣金发放（权限与状态） | 财务/管理员 | 调用 `/commission/issue/{id}` | 成功；状态=已发放 | P1 |
| TC-COMM-004 | 按交易获取佣金 | 登录 | `/commission/by-transaction/{transactionId}` | 返回对应佣金或空 | P2 |

### 8.10 团队管理

| 用例ID | 场景 | 前置条件 | 步骤 | 期望结果 | 优先级 |
|---|---|---|---|---|---|
| TC-TEAM-001 | 团队列表分页 | 登录 | 查询团队列表 | 正确分页、字段正确 | P3 |
| TC-TEAM-002 | 团队业绩统计 | 登录 | 查询 `/team/performance` | 返回统计数据，图表可渲染 | P3 |

### 8.11 工作通知

| 用例ID | 场景 | 前置条件 | 步骤 | 期望结果 | 优先级 |
|---|---|---|---|---|---|
| TC-NOTICE-001 | 发送通知 | 管理员/允许发送角色 | 发送通知 `/work-notice/send` | 发送成功；接收方列表可见；未读数变化 | P2 |
| TC-NOTICE-002 | 标记已读 | 登录 | 点击通知或调用 `/work-notice/read/{id}` | 未读数减少；该条状态为已读 | P2 |
| TC-NOTICE-003 | 功能开关禁用 | `feature.notice.enabled=false` | 请求通知接口 | 返回 403“消息/通知功能已禁用” | P2 |

### 8.12 在线聊天

| 用例ID | 场景 | 前置条件 | 步骤 | 期望结果 | 优先级 |
|---|---|---|---|---|---|
| TC-CHAT-001 | 创建私聊会话 | 登录两个用户 | A 对 B 发起会话 `/chat/session/private` | 创建成功；会话列表出现；不能与自己聊天 | P2 |
| TC-CHAT-002 | 发送文本消息 | 会话存在 | `/chat/message/send` 发送文本 | 成功；会话 lastMessage 更新；对方未读数+1 | P2 |
| TC-CHAT-003 | 标记已读 | 有未读消息 | `/chat/session/read` | 未读数清零 | P2 |
| TC-CHAT-004 | 上传图片消息 | 登录 | `/chat/upload/image` 上传图片并发送 msgType=2 | 返回可访问 URL；前端可预览 | P2 |
| TC-CHAT-005 | 功能开关禁用 | `feature.chat.enabled=false` | 访问聊天接口 | 返回 403“聊天功能已禁用” | P2 |

### 8.13 报表与导出

| 用例ID | 场景 | 前置条件 | 步骤 | 期望结果 | 优先级 |
|---|---|---|---|---|---|
| TC-REPORT-001 | 销售报表查询 | 登录 | GET `/report/sale` | 返回列表结构正确 | P3 |
| TC-REPORT-002 | 报表导出下载 | 登录 | GET `/report/sale/export` | 下载 Excel；文件名正确；内容可打开 | P2 |
| TC-REPORT-003 | 财务/客户报表查询与导出 | 登录 | financial/customer 同上 | 同上 | P3 |

### 8.14 统计接口

| 用例ID | 场景 | 前置条件 | 步骤 | 期望结果 | 优先级 |
|---|---|---|---|---|---|
| TC-STAT-001 | 房源统计 | 登录 | GET `/statistics/house` | 返回统计字段完整，页面展示正常 | P3 |
| TC-STAT-002 | 客户统计 | 登录 | GET `/statistics/customer` | 同上 | P3 |
| TC-STAT-003 | 交易/收款/佣金统计 | 登录 | GET `/statistics/transaction/payment/commission` | 同上 | P3 |

### 8.15 操作日志

| 用例ID | 场景 | 前置条件 | 步骤 | 期望结果 | 优先级 |
|---|---|---|---|---|---|
| TC-LOG-001 | 管理员查看全部日志 | roleType=1 | 查询 `/operation-log/page` | 返回全部/按条件过滤 | P3 |
| TC-LOG-002 | 非管理员只能看自己的日志 | roleType!=1 | 查询 `/operation-log/page` | 后端自动限制 userId=本人 | P3 |

---

## 9. 异常与安全测试（重点）

- **未登录**：除 `/auth/login` 外接口返回 401。
- **权限不足**：应返回 403 或业务失败（以 `ResponseResult` message 为准）。
- **输入校验**：
  - 登录用户名危险字符拦截
  - 上传文件类型/大小限制（5MB）
  - 交易流转阶段约束（经理审核/完成审核/字段级权限）
- **前端错误提示**：
  - 默认全局 `ElMessage` 提示错误
  - 登录请求为 `silent`，避免重复弹窗
  - 轮询请求为 `silent`，避免刷屏

---

## 10. 性能与稳定性建议（抽测指标）

- 列表分页接口（房源/客户/交易/收款/佣金）：
  - **P95** 响应 < 800ms（本地环境）
  - pageSize=100 时不应出现前端卡死
- 并发：
  - 同房源并发创建交易，确保只产生 1 条有效交易
- 导出：
  - 10k 行以内导出可在合理时间完成（按数据量调优）

---

## 11. 缺陷等级与退出准则

### 11.1 缺陷等级

- **P0（致命）**：无法登录/核心流程不可用/数据错误写入/安全严重问题
- **P1（严重）**：主要功能不可用/权限越权/流程中断但有替代路径
- **P2（一般）**：提示不友好/边缘功能异常/偶发问题
- **P3（轻微）**：UI 小问题/文案/样式

### 11.2 测试退出准则（建议）

- P0 = 0
- P1 ≤ 2 且有明确规避方案
- 核心用例（P0 标记）100% 通过
- 关键角色权限用例通过率 ≥ 95%

---

## 12. 附录：请求约定

- **统一响应结构**：`{ code: number, status: boolean, message: string, data: any }`
- **认证头**：`Authorization: Bearer <token>`
- **后端默认地址**：`http://localhost:8080`
- **前端开发地址**：Vite 默认 `http://localhost:5173`（以实际为准）
